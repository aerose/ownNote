[TOC]
<font face = "Consolas">
# 系统级IO P624

****

## Unix IO
> 所有IO设备都模型化为文件,输入输出当作对文件的读写
### 打开文件: 
* 程序向**内核**请求打开相应文件表示想访问一个IO设备
* 内核返回非负整数**描述符**,标识此文件
* 文件所有信息由内核记录,程序只需记住描述符
    > shell创建每个进程开始时都有3个打开的文件:标准输入 标准输出 标准错误
### 改变文件位置:
* 内核对打开的文件维护**文件位置k**,为文件开头起始的字节偏移量
### 读写文件:
* 文件位置k>=文件大小m时,读操作会触发EOF(文件结尾没有明确的EOF)
### 关闭文件:
* 内核响应程序对文件的关闭请求
* 内核释放文件打开创建的数据结构,描述符恢复到可用的描述符池

****

## 文件类型
> 程序需区分文本文件和二进制文件,内核不需要
### 目录:
> 包含一组链接的文件
* 每个链接都将一个文件名(filename)映射到一个文件(可能是目录)

****

## RIO包 P626-P631

****

## 读取文件元数据
>元数据即文件的信息
### stat()
* ```int stat(const char *filename, struct stat *buf)```
* 输入文件名,填写stat

****

## 读取目录内容
### opendir
* ```DIR *opendir(const char *name)```
* 路径名为参数,返回指向目录流的指针(目录项的列表)
### readdir
* ```struct dirent *readdir(DIR *dirp)```
* 返回指向流dirp下一个目录项的指针
### closedir
* ```int closedir(DIR *dirp)```
* 关闭流, 释放所有资源

****

## 共享文件
### 内核已打开文件表示
* 描述符表: 进程打开文件的表
    > 每进程独立
    由进程打开文件的描述符索引
    打开的描述符表项指向文件表中的一个表项
* 文件表: 打开文件的集合
    > 所有进程共享
    表项包括当前文件位置,引用计数(指向该表项的描述符表项数),指向v-node表中对应表项的指针
* v-node表: 文件的信息
    > 所有进程共享
    表项包括stat结构的大多数信息
### 共享
> 描述符指向不同的文件表,指向的表项都指向v-node表中同一个文件
* 父子进程共享:
    > 子进程有父进程描述符表的副本
### IO重定向
* ```int dup2(int oldfd, int newfd)```
* 覆盖描述符*表项*